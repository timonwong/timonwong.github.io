<!doctype html><html><head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge"><title>å°†é’‰é’‰æ¥å…¥ Prometheus AlertManager WebHook - Timon Wong</title><meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="TL;DR
Disclaimer: Personally I dislike DingTalk(a.k.a DingDing) at all ğŸ˜œ.
Project Repo: https://github.com/timonwong/prometheus-webhook-dingtalk">
<meta property="og:image" content>
<meta property="og:title" content="å°†é’‰é’‰æ¥å…¥ Prometheus AlertManager WebHook">
<meta property="og:description" content="TL;DR
Disclaimer: Personally I dislike DingTalk(a.k.a DingDing) at all ğŸ˜œ.
Project Repo: https://github.com/timonwong/prometheus-webhook-dingtalk">
<meta property="og:type" content="article">
<meta property="og:url" content="https://theo.im/blog/2017/10/16/release-prometheus-alertmanager-webhook-for-dingtalk/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2017-10-16T21:08:03+00:00">
<meta property="article:modified_time" content="2017-10-16T21:08:03+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="å°†é’‰é’‰æ¥å…¥ Prometheus AlertManager WebHook">
<meta name=twitter:description content="TL;DR
Disclaimer: Personally I dislike DingTalk(a.k.a DingDing) at all ğŸ˜œ.
Project Repo: https://github.com/timonwong/prometheus-webhook-dingtalk">
<script src=https://theo.im/js/feather.min.js></script>
<link href=https://theo.im/css/fonts.b685ac6f654695232de7b82a9143a46f9e049c8e3af3a21d9737b01f4be211d1.css rel=stylesheet>
<link rel=stylesheet type=text/css media=screen href=https://theo.im/css/main.2f9b5946627215dc1ae7fa5f82bfc9cfcab000329136befeea5733f21e77d68f.css>
</head>
<body>
<div class=content><header>
<div class=main>
<a href=https://theo.im/>Timon Wong</a>
</div>
<nav>
<a href=/>Home</a>
<a href=/posts>Posts</a>
<a href=/tags>Tags</a>
</nav>
</header>
<main>
<article>
<div class=title>
<h1 class=title>å°†é’‰é’‰æ¥å…¥ Prometheus AlertManager WebHook</h1>
<div class=meta>Posted on Oct 16, 2017</div>
</div>
<section class=body>
<h2 id=tldr>TL;DR</h2>
<p><strong>Disclaimer</strong>: Personally I dislike <a href=https://www.dingtalk.com>DingTalk</a>(a.k.a DingDing) at all ğŸ˜œ.</p>
<p>Project Repo: <a href=https://github.com/timonwong/prometheus-webhook-dingtalk>https://github.com/timonwong/prometheus-webhook-dingtalk</a></p>
<h2 id=why>Why</h2>
<p>åœ¨æ•äººçš„ã€Œå¿½æ‚ ã€ä¸‹ï¼Œæ•å‚åœ¨ 2016 å¹´ä¸­å°±å…¨é¢ä½¿ç”¨äº† <a href=https://prometheus.io>Prometheus</a> ä½œä¸ºç›‘æ§ç³»ç»Ÿï¼Œè¿™ä¸ªç³»ç»Ÿç°åœ¨å·²ç»æ¯”è¾ƒç«äº†ï¼Œè¿™é‡Œå°±ä¸å†å¤šåŠ å£èˆŒé˜è¿°ã€‚åæ¥ï¼Œæ•å‚ä½¿ç”¨äº†é’‰é’‰ä½œä¸ºå…¬å¸å†…éƒ¨çš„æŒ‡å®šé€šï¼ˆdÄƒï¼‰è®¯ï¼ˆkÄƒï¼‰è½¯ä»¶ï¼Œå–ä»£äº† <a href=https://slack.com>Slack</a>ã€‚ä¸å¾—ä¸è¯´ï¼Œæ¯”èµ· <a href=https://slack.com>Slack</a> æ¥ï¼Œæ˜¾ç¤ºæŠ¥è­¦é€šçŸ¥ï¼Œé’‰é’‰ä¸ç¾è§‚ã€‚</p>
<p>æŒ‰ç…§æˆ‘ä¸ªäººçš„çœ‹æ³•ï¼Œä¸€ä¸ªåˆæ ¼çš„æŠ¥è­¦é€šçŸ¥ï¼Œåº”è¯¥åŒ…å«å¦‚ä¸‹å†…å®¹ï¼š</p>
<ul>
<li>æŠ¥è­¦çº§åˆ«</li>
<li>ç®€çŸ­çš„æŠ¥è­¦åç§°</li>
<li>ç®€è¦è¯´æ˜</li>
<li>è¯¦ç»†è¯´æ˜</li>
<li>é™„åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯</li>
<li>ä¸€ä¸ªé“¾æ¥ï¼Œç‚¹å‡»åè¿›å…¥æŒ‡æ ‡çš„ Graph</li>
</ul>
<p>å¹¸è¿çš„æ˜¯ï¼Œ<a href=https://prometheus.io>Prometheus</a> <a href=https://github.com/prometheus/alertmanager>AlertManager</a> å·²ç»åŒ…å«äº†ä¸€ä¸ªåšå¾—æ¯”è¾ƒå¥½çš„ <a href=https://slack.com>Slack</a> æŠ¥è­¦æ¨¡æ¿ï¼Œåªéœ€è¦ä»<a href=https://github.com/prometheus/docs/blob/db2a09a8a7e193d6e474f37055908a6d432b88b5/content/docs/alerting/configuration.md#webhook_config>è¿™é‡Œ</a>å¼€å§‹å°±å¯ä»¥äº†ã€‚</p>
<h2 id=routes>Routes</h2>
<p><code>prometheus-webhook-dingtalk</code> é»˜è®¤ç›‘å¬åœ¨<code>8060</code>ç«¯å£ï¼ˆå¯é…ç½®ï¼‰ä¸Šï¼Œæä¾›äº†ä»¥ä¸‹è·¯ç”±ä¾› <a href=https://github.com/prometheus/alertmanager>AlertManager</a> çš„ <a href=https://prometheus.io/docs/alerting/configuration/#%3Cwebhook_config%3E>webhook_configs</a> ä½¿ç”¨ï¼š</p>
<ul>
<li><code>/dingtalk/&lt;profile>/send</code></li>
</ul>
<p>æ³¨æ„è¿™é‡Œçš„ <code>&lt;profile></code> éœ€è¦åœ¨ <code>-ding.profile</code> ä¸­æŒ‡å®šç›¸åº”çš„åç§°ï¼ˆ<code>&lt;profile></code>ï¼‰ä»¥åŠé’‰é’‰çš„è‡ªå®šä¹‰æœºå™¨äºº WebHook URLï¼ˆ<code>&lt;dingtalk-webhook-url></code>ï¼‰ã€‚</p>
<h2 id=usage>Usage</h2>
<p>é¦–å…ˆï¼Œæˆ‘ä¸ªäººä¸å–œæ¬¢éšå¤„éƒ½æ˜¯é…ç½®æ–‡ä»¶çš„ç°è±¡ï¼Œå› æ­¤ <code>prometheus-webhook-dingtalk</code> çš„æ‰€æœ‰é…ç½®é€šè¿‡å‘½ä»¤è¡Œå‚æ•°å®Œæˆ:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>usage: prometheus-webhook-dingtalk --ding.profile=DING.PROFILE [&lt;flags&gt;]

Flags:
  -h, --help             Show context-sensitive help (also try --help-long and --help-man).
      --web.listen-address=&#34;:8060&#34;
                         The address to listen on for web interface.
      --ding.profile=DING.PROFILE ...
                         Custom DingTalk profile (can specify multiple times, &lt;profile&gt;=&lt;dingtalk-url&gt;).
      --ding.timeout=5s  Timeout for invoking DingTalk webhook.
      --log.level=info   Only log messages with the given severity or above. One of: [debug, info, warn, error]
      --version          Show application version.
</code></pre></div><p>å…³äºè¿™é‡Œçš„ <code>-ding.profile</code> å‚æ•°ï¼šä¸ºäº†æ”¯æŒåŒæ—¶å¾€å¤šä¸ªé’‰é’‰è‡ªå®šä¹‰æœºå™¨äººå‘é€æŠ¥è­¦æ¶ˆæ¯ï¼Œå› æ­¤ <code>-ding.profile</code> å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­æŒ‡å®šå¤šæ¬¡ï¼Œæ¯”å¦‚:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>prometheus-webhook-dingtalk <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --ding.profile<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;webhook1=https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxxxxx&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --ding.profile<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;webhook2=https://oapi.dingtalk.com/robot/send?access_token=yyyyyyyyyyy&#34;</span>
</code></pre></div><p>è¿™é‡Œå°±å®šä¹‰äº†ä¸¤ä¸ª WebHookï¼Œä¸€ä¸ª <code>webhook1</code>ï¼Œä¸€ä¸ª <code>webhook2</code>ï¼Œç”¨æ¥å¾€ä¸åŒçš„é’‰é’‰ç»„å‘é€æŠ¥è­¦æ¶ˆæ¯ã€‚</p>
<p>ç„¶ååœ¨ <a href=https://github.com/prometheus/alertmanager>AlertManager</a> çš„é…ç½®é‡Œé¢ï¼ŒåŠ å…¥ç›¸åº”çš„ <code>receiver</code>ï¼ˆæ³¨æ„ä¸‹é¢çš„ <code>url</code>ï¼‰å³å¯ï¼š</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>receivers</span>:
- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>send_to_dingding_webhook1</span>
  <span style=color:#f92672>webhook_configs</span>:
  - <span style=color:#f92672>send_resolved</span>: <span style=color:#66d9ef>false</span>
    <span style=color:#f92672>url</span>: <span style=color:#ae81ff>http://localhost:8060/dingtalk/webhook1/send</span>
- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>send_to_dingding_webhook2</span>
  <span style=color:#f92672>webhook_configs</span>:
  - <span style=color:#f92672>send_resolved</span>: <span style=color:#66d9ef>false</span>
    <span style=color:#f92672>url</span>: <span style=color:#ae81ff>http://localhost:8060/dingtalk/webhook2/send</span>
</code></pre></div><h3 id=in-action>In Action</h3>
<p>å‚è§å®˜æ–¹æ–‡ç« ï¼š<a href="https://open-doc.dingtalk.com/docs/doc.htm?treeId=257&articleId=105735&docType=1">https://open-doc.dingtalk.com/docs/doc.htm?treeId=257&articleId=105735&docType=1</a>ï¼Œç„¶åå°† webhook åœ°å€æ‹·è´ä¸‹æ¥ï¼Œä¼ ç»™ <code>prometheus-webhook-dingtalk</code>ã€‚</p>
<p>æœ€åï¼Œæ¥ä¸ªæˆªå›¾çœ‹çœ‹æ•ˆæœå§ï¼š</p>
<p><img src=https://theo-im-1255089908.cos.ap-chengdu.myqcloud.com/images/2016-10-16-dingtalk-in-action.png alt></p>
</section>
<div class=post-tags>
<nav class="nav tags">
<ul class=tags>
<li><a href=/tags/prometheus>Prometheus</a></li>
</ul>
</nav>
</div>
</article>
</main>
<footer>
<hr><a class=soc href=https://github.com/timonwong title=GitHub><i data-feather=github></i></a>|âš¡ï¸
2021 Â© timonwong | <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a>
</footer>
<script>feather.replace()</script></div>
</body>
</html>