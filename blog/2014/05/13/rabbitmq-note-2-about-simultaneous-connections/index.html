<!doctype html><html><head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge"><title>RabbitMQ笔记（二）: 并发连接数 - Timon Wong</title><meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="概要 对于服务器来说，并发连接数一直是一个需要考量的问题，因此在这里做一个简单的测试。
测试 在测试前，需要准备一个客户端环境，本文的环境是:
 CentOS 6.3 Python 2.7.6  Kombu    NOTE: 下文中的 IP 地址 10.10.0.70 为 RabbitMQ 服务器的 IP 地址
测试: 耗尽 rabbitmq 的 socket descriptors 首先, 编写一个脚本:
#!/usr/bin/env python # -*- coding: utf-8 -*- import os import logging import config logging.basicConfig(format='%(asctime)s- %(name)s- %(levelname)s- %(message)s', level=logging.INFO) LOG = logging.getLogger(os.path.basename(__file__)) def main(): connections = [] while True: LOG.info(&#34;Try to establish a new rabbit connection...&#34;) connection = config.get_connection() connection.">
<meta property="og:image" content>
<meta property="og:title" content="RabbitMQ笔记（二）: 并发连接数">
<meta property="og:description" content="概要 对于服务器来说，并发连接数一直是一个需要考量的问题，因此在这里做一个简单的测试。
测试 在测试前，需要准备一个客户端环境，本文的环境是:
 CentOS 6.3 Python 2.7.6  Kombu    NOTE: 下文中的 IP 地址 10.10.0.70 为 RabbitMQ 服务器的 IP 地址
测试: 耗尽 rabbitmq 的 socket descriptors 首先, 编写一个脚本:
#!/usr/bin/env python # -*- coding: utf-8 -*- import os import logging import config logging.basicConfig(format='%(asctime)s- %(name)s- %(levelname)s- %(message)s', level=logging.INFO) LOG = logging.getLogger(os.path.basename(__file__)) def main(): connections = [] while True: LOG.info(&#34;Try to establish a new rabbit connection...&#34;) connection = config.get_connection() connection.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://theo.im/blog/2014/05/13/rabbitmq-note-2-about-simultaneous-connections/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2014-05-13T16:16:21+00:00">
<meta property="article:modified_time" content="2014-05-13T16:16:21+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="RabbitMQ笔记（二）: 并发连接数">
<meta name=twitter:description content="概要 对于服务器来说，并发连接数一直是一个需要考量的问题，因此在这里做一个简单的测试。
测试 在测试前，需要准备一个客户端环境，本文的环境是:
 CentOS 6.3 Python 2.7.6  Kombu    NOTE: 下文中的 IP 地址 10.10.0.70 为 RabbitMQ 服务器的 IP 地址
测试: 耗尽 rabbitmq 的 socket descriptors 首先, 编写一个脚本:
#!/usr/bin/env python # -*- coding: utf-8 -*- import os import logging import config logging.basicConfig(format='%(asctime)s- %(name)s- %(levelname)s- %(message)s', level=logging.INFO) LOG = logging.getLogger(os.path.basename(__file__)) def main(): connections = [] while True: LOG.info(&#34;Try to establish a new rabbit connection...&#34;) connection = config.get_connection() connection.">
<script src=https://theo.im/js/feather.min.js></script>
<link href=https://theo.im/css/fonts.b685ac6f654695232de7b82a9143a46f9e049c8e3af3a21d9737b01f4be211d1.css rel=stylesheet>
<link rel=stylesheet type=text/css media=screen href=https://theo.im/css/main.2f9b5946627215dc1ae7fa5f82bfc9cfcab000329136befeea5733f21e77d68f.css>
</head>
<body>
<div class=content><header>
<div class=main>
<a href=https://theo.im/>Timon Wong</a>
</div>
<nav>
<a href=/>Home</a>
<a href=/posts>Posts</a>
<a href=/tags>Tags</a>
</nav>
</header>
<main>
<article>
<div class=title>
<h1 class=title>RabbitMQ笔记（二）: 并发连接数</h1>
<div class=meta>Posted on May 13, 2014</div>
</div>
<section class=body>
<h2 id=概要>概要</h2>
<p>对于服务器来说，并发连接数一直是一个需要考量的问题，因此在这里做一个简单的测试。</p>
<h2 id=测试>测试</h2>
<p>在测试前，需要准备一个客户端环境，本文的环境是:</p>
<ul>
<li>CentOS 6.3</li>
<li>Python 2.7.6
<ul>
<li><a href=http://kombu.readthedocs.org/>Kombu</a></li>
</ul>
</li>
</ul>
<p><strong>NOTE:</strong> 下文中的 IP 地址 <code>10.10.0.70</code> 为 RabbitMQ 服务器的 IP 地址</p>
<h3 id=测试-耗尽-rabbitmq-的-socket-descriptors>测试: 耗尽 rabbitmq 的 socket descriptors</h3>
<p>首先, 编写一个脚本:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#75715e>#!/usr/bin/env python</span>
<span style=color:#75715e># -*- coding: utf-8 -*-</span>
<span style=color:#f92672>import</span> os
<span style=color:#f92672>import</span> logging

<span style=color:#f92672>import</span> config

logging<span style=color:#f92672>.</span>basicConfig(format<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>%(asctime)s</span><span style=color:#e6db74> - </span><span style=color:#e6db74>%(name)s</span><span style=color:#e6db74> - </span><span style=color:#e6db74>%(levelname)s</span><span style=color:#e6db74> - </span><span style=color:#e6db74>%(message)s</span><span style=color:#e6db74>&#39;</span>,
                    level<span style=color:#f92672>=</span>logging<span style=color:#f92672>.</span>INFO)
LOG <span style=color:#f92672>=</span> logging<span style=color:#f92672>.</span>getLogger(os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>basename(__file__))


<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
    connections <span style=color:#f92672>=</span> []
    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
        LOG<span style=color:#f92672>.</span>info(<span style=color:#e6db74>&#34;Try to establish a new rabbit connection...&#34;</span>)
        connection <span style=color:#f92672>=</span> config<span style=color:#f92672>.</span>get_connection()
        connection<span style=color:#f92672>.</span>connect()
        connections<span style=color:#f92672>.</span>append(connection)
        LOG<span style=color:#f92672>.</span>info(<span style=color:#e6db74>&#34;[</span><span style=color:#e6db74>%d</span><span style=color:#e6db74>] connections&#34;</span>, len(connections))


<span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
    main()
</code></pre></div><p>在<strong>客户端</strong>执行<code>exhaust_socket_descriptors.py</code>, 会看到如下输出:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>...前略...
2014-05-13 10:45:17,477 - exhaust_socket_descriptors.py - INFO - Try to establish a new rabbit connection...
2014-05-13 10:45:17,489 - exhaust_socket_descriptors.py - INFO - [826] connections
2014-05-13 10:45:17,489 - exhaust_socket_descriptors.py - INFO - Try to establish a new rabbit connection...
2014-05-13 10:45:17,502 - exhaust_socket_descriptors.py - INFO - [827] connections
2014-05-13 10:45:17,502 - exhaust_socket_descriptors.py - INFO - Try to establish a new rabbit connection...
2014-05-13 10:45:17,516 - exhaust_socket_descriptors.py - INFO - [828] connections
2014-05-13 10:45:17,516 - exhaust_socket_descriptors.py - INFO - Try to establish a new rabbit connection...
2014-05-13 10:45:17,528 - exhaust_socket_descriptors.py - INFO - [829] connections
2014-05-13 10:45:17,529 - exhaust_socket_descriptors.py - INFO - Try to establish a new rabbit connection...
</code></pre></div><p>看到似乎是连接耗尽了，在<strong>服务器端</strong>上确认一下：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>[root@localhost vagrant]# rabbitmqctl status | grep sockets_
      {sockets_limit,829},
      {sockets_used,829}]},
</code></pre></div><p><code>sockets_used</code> 与 <code>sockets_limit</code> 相同，可以确认 socket descriptors 耗尽了，因此客户端成功新连接，卡在
<code>Try to establish a new rabbit connection...</code> 处。但是问题在于，<strong>为什么不超时？</strong></p>
<p>在<strong>客户端</strong>中检查一下TCP连接个数:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>[root@localhost ~]# netstat -atn | grep 10.10.0.70:5672 | wc -l
830
</code></pre></div><p>可以得出，socket连接数是830，大于服务器端的<code>sockets_limit</code></p>
<p>继续，在<strong>客户端</strong>中，检查一下TCP连接状态：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>[root@localhost ~]# netstat -atn | grep 10.10.0.70:5672  | awk &#39;{print $6}&#39; | uniq
ESTABLISHED
</code></pre></div><p><strong>全部都是ESTABLISHED状态</strong>，因此服务器仅仅是阻塞了新连接，而不是拒绝新连接。这样，就产生了一个问题：</p>
<p>如果是使用 <a href=http://clusterlabs.org/>HAProxy</a> 等工具搭建的集群，由于<strong>服务器依然会接受新连接</strong>，因此 <a href=http://clusterlabs.org/>HAProxy</a> 不会认为节点已Down，<strong>最终会导致整个集群卡住</strong>；</p>
<h3 id=bug>Bug</h3>
<p>当 RabbitMQ 的 <code>sockets_used</code> 达到 <code>sockets_limits</code> 时候（连接数耗尽时），最终即使是 Consumer
也会全部阻塞，只有在 <code>sockets_used &lt; sockets_limit</code> 时（释放部分连接后），才会恢复。</p>
<p>参见以下连接获取更多信息: <a href=http://markmail.org/message/r4yhvqc7vgfljpao>http://markmail.org/message/r4yhvqc7vgfljpao</a></p>
<h2 id=workaround-增加filesocket-descriptors个数>Workaround: 增加File/Socket Descriptors个数</h2>
<p>通过官方(包括EPEL)的 <code>deb</code>, <code>rpm</code> 包安装的启动脚本，都会在<code>rabbitmq-server</code>
启动前 <code>source</code> 一次 <code>/etc/default/rabbitmq-server</code> 文件，因此我们可以在该文件中增加最大允许的
File/Socket Descriptors 个数。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>echo <span style=color:#e6db74>&#39;ulimit -n 102400&#39;</span> &gt; /etc/default/rabbitmq-server
</code></pre></div><p>最后，重启 RabbitMQ 服务器以生效该设置：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>service rabbitmq-server restart
</code></pre></div><h2 id=updated>Updated</h2>
<h3 id=may-17-2014>May 17, 2014</h3>
<ul>
<li>更新 Bug 说明 (RabbitMQ <code>bug26180</code>)</li>
</ul>
</section>
<div class=post-tags>
</div>
</article>
</main>
<footer>
<hr><a class=soc href=https://github.com/timonwong title=GitHub><i data-feather=github></i></a>|⚡️
2021 © timonwong | <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a>
</footer>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-35644871-2','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<script>feather.replace()</script></div>
</body>
</html>